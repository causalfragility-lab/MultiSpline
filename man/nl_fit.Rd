% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/nl_fit.R
\name{nl_fit}
\alias{nl_fit}
\title{Fit a nonlinear (spline or GAM) single-level or multilevel model}
\usage{
nl_fit(
  data,
  y,
  x,
  time = NULL,
  cluster = NULL,
  controls = NULL,
  method = c("ns", "gam"),
  df = 4,
  k = 5,
  family = stats::gaussian(),
  ...
)
}
\arguments{
\item{data}{A data frame (often long format for longitudinal data).}

\item{y}{Outcome variable name (string).}

\item{x}{Focal nonlinear predictor name (string). Must be numeric.}

\item{time}{Optional time variable name (string). If provided, a
spline-by-time interaction is included for \code{method = "ns"}; for
\code{method = "gam"}, a factor \code{time} uses
\code{s(x, by = time)} (group-specific smooths), while a numeric
\code{time} uses \code{s(x, k = k) + time + ti(x, time, k = k)}
(tensor interaction).}

\item{cluster}{Optional character vector of grouping variable name(s) for
random intercepts, e.g., \code{NULL}, \code{"id"}, or
\code{c("id", "schid")}.}

\item{controls}{Optional character vector of additional covariate names to
include linearly.}

\item{method}{Either \code{"ns"} (natural spline) or \code{"gam"} (GAM
smooth). Multilevel fits are currently supported only for \code{"ns"}.}

\item{df}{Degrees of freedom for \code{splines::ns()} when
\code{method = "ns"}. Must be a single numeric value >= 1. Default
is \code{4}.}

\item{k}{Basis dimension for \code{mgcv::s()} and \code{mgcv::ti()} when
\code{method = "gam"}. Must be a single numeric value >= 3. Default
is \code{5}.}

\item{family}{A model family object, e.g., \code{stats::gaussian()} or
\code{stats::binomial()}. For multilevel fits, \code{gaussian()} uses
\code{lme4::lmer()} and non-Gaussian families use \code{lme4::glmer()}.}

\item{...}{Additional arguments passed to the underlying fitting function
(\code{stats::lm()}, \code{mgcv::gam()}, \code{lme4::lmer()}, or
\code{lme4::glmer()}).}
}
\value{
An object of class \code{"nl_fit"} (a named list) containing:
\describe{
\item{\code{model}}{The fitted model object.}
\item{\code{method}}{The fitting method used (\code{"ns"} or
\code{"gam"}).}
\item{\code{y}}{Name of the outcome variable.}
\item{\code{x}}{Name of the focal predictor.}
\item{\code{time}}{Name of the time variable, or \code{NULL}.}
\item{\code{cluster}}{Character vector of clustering variables, or
\code{NULL}.}
\item{\code{controls}}{Character vector of control variable names, or
\code{NULL}.}
\item{\code{df}}{Degrees of freedom used for \code{splines::ns()}.}
\item{\code{k}}{Basis dimension used for \code{mgcv::s()} /
\code{mgcv::ti()}.}
\item{\code{family}}{The family object used.}
\item{\code{formula}}{The model formula passed to the fitter.}
\item{\code{call}}{The matched call.}
\item{\code{x_info}}{A list with quantiles and range of \code{x} for
building prediction grids: \code{q01}, \code{q99}, \code{min},
\code{max}, \code{n}.}
\item{\code{levels_info}}{A named list of factor levels for \code{time}
and any factor control variables.}
\item{\code{control_defaults}}{A named list of typical values for control
variables: the mean for numeric variables and the first level for
factors.}
}
}
\description{
Fits a nonlinear regression model for an outcome \code{y} with a focal
predictor \code{x}, modeled either by a natural cubic spline
(\code{splines::ns()}) or a GAM smooth (\code{mgcv::s()}).

Optionally includes a time variable \code{time}. For spline fits
(\code{method = "ns"}), multilevel random-intercept structure can be added
via one or more grouping variables in \code{cluster}.

Models fitted:
\itemize{
\item Single-level spline: \code{stats::lm()}
\item Single-level GAM: \code{mgcv::gam()}
\item Multilevel spline: \code{lme4::lmer()} (Gaussian) or
\code{lme4::glmer()} (non-Gaussian)
}
}
\examples{
\dontrun{
# Single-level natural spline
fit_sl <- nl_fit(data = mydata, y = "outcome", x = "age", df = 4)

# Single-level GAM
fit_gam <- nl_fit(
  data   = mydata,
  y      = "outcome",
  x      = "age",
  method = "gam",
  k      = 5
)

# Multilevel spline with random intercepts
fit_ml <- nl_fit(
  data    = mydata,
  y       = "outcome",
  x       = "age",
  cluster = "id",
  df      = 4
)

# Spline with time interaction and controls
fit_t <- nl_fit(
  data     = mydata,
  y        = "outcome",
  x        = "age",
  time     = "wave",
  controls = c("sex", "baseline_score"),
  df       = 4
)
}

}
\seealso{
\code{\link[splines]{ns}}, \code{\link[mgcv]{gam}},
\code{\link[lme4]{lmer}}, \code{\link[lme4]{glmer}}
}
